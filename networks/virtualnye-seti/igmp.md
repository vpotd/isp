# IGMP, IGMP snooping, MVR

### **IGMP**

**IGMP** \(англ. _Internet Group Management Protocol_ — протокол управления группами Интернета\) — протокол управления групповой \(multicast\) передачей данных в сетях, основанных на протоколе IP. IGMP используется маршрутизаторами и IP-узлами для организации сетевых устройств в группы. Протокол IGMP реализован в виде серверной и клиентской частей, первая из которых выполняется на маршрутизаторе, вторая — в узле сети, получающем групповой трафик. Клиент посылает уведомление о принадлежности к какой-либо группе локальному маршрутизатору, в это время маршрутизатор находится в ожидании уведомлений и периодически рассылает клиентам запросы. Сообщения IGMP инкапсулируются в IP-пакеты с номером протокола 2, поле TTL равно 1. Так как TTL равно 1, то маршрутизаторы не передают пакеты IGMP.

Этот протокол является частью спецификации групповой передачи пакетов в IP-сетях. IGMP расположен на сетевом уровне. Он во многом аналогичен [ICMP](http://ru.wikipedia.org/wiki/ICMP) для односторонней передачи. IGMP может использоваться для поддержки потокового видео и онлайн-игр, для этих типов приложений он позволяет использовать сетевые ресурсы более эффективно. IGMP уязвим к некоторым атакам, и брандмауэры обычно позволяют пользователю отключить этот протокол, если в нем нет необходимости.

IGMP используется только в сетях IPv4, так как в IPv6 групповая передача пакетов реализована через протокол Multicast Listener Discovery.

Итак, положим, что в автономной системе существует совокупность маршрутизаторов, к котором подключены узлы, поддерживающие получение multicast. С помощью IGMP каждый из маршрутизаторов должен получить актуальные в каждый момент времени сведения о том, члены каких multicast групп присутствуют за каждым интерфейсом маршрутизатора, впоследствии эта информация будет использована как основа для обмена данными в рамках протокола динамической маршрутизации multicast трафика. Рассматривая сегодня IGMP, мы не будем интересоваться тем, как узлы подключены к маршрутизаторам, т.е. не будем интересоваться L2 топологией и, что самое главное, не будем интересоваться оптимизацией передачи multicast в L2 топологиях. Пока будем полагать, что узлы подключены к маршрутизаторам с помощью L2 коммутаторов, которые обрабатывают multicast простым flooding, как и broadcast, т.е. передают полученный multicast кадр на все порты, исключая порт, с которого кадр поступил. Такой подход позволит нам быстро разобраться с поставленной задачей, т.е. понять, как маршрутизаторы поддерживают актуальные сведения о подключенных членах групп. Что же касается вопросов оптимизации L2 инфраструктуры, этому будет посвящена следующая статья. Для решения поставленной задачи, узлы и порт маршрутизатора в каждой L2 сети обмениваются пакетами протокола IGMP, к непосредственному рассмотрению которого мы и переходим.

### IGMP snooping <a id="IGMP.IGMPSnooping.MVR-IGMPsnooping"></a>

**IGMP snooping** — процесс отслеживания сетевого трафика [IGMP](http://ru.wikipedia.org/wiki/Internet_Group_Management_Protocol), который позволяет сетевым устройствам канального уровня \(свитчам\) отслеживать IGMP-обмен между потребителями и поставщиками \(маршрутизаторами\) многоадресного \(multicast\) IP-трафика, формально происходящий на более высоком \(сетевом\) уровне. Эта функциональность доступна во многих управляемых коммутаторах для сети Ethernet \(по крайней мере среднего и верхнего ценовых уровней\), но всегда требует отдельного включения и настройки.

После включения IGMP snooping коммутатор начинает анализировать все IGMP-пакеты между подключенными к нему компьютерами-потребителями и маршрутизаторами-поставщиками multicast трафика. Обнаружив IGMP-запрос потребителя на подключение к multicast группе, коммутатор включает порт, к которому тот подключён, в список её членов \(для ретрансляции группового трафика\). И наоборот: услышав запрос 'IGMP Leave' \(покинуть\), удаляет соответствующий порт из списка группы.

IGMP snooping разработан для предотвращения широковещательной \(broadcast\) ретрансляции multicast трафика компьютерам-потребителям, которые явно не заявили о своей заинтересованности в нём. Это позволяет коммутаторам исключать такой трафик из потоков, направляемых через порты, к которым не подключено его потребителей, тем самым существенно снижая нагрузку на сеть. Однако при этом нагрузка на сам коммутатор не снижается, а повышается, поскольку такая фильтрация требует затрат памяти, NPU и CPU, в то время как простая ретрансляция по всем портам — операция дешёвая. По умолчанию, без функции IGMP snooping, коммутатор ретранслирует multicast трафик по всем своим портам, принадлежащим к тому же широковещательному домену или VLAN, что не только бесполезно, но и способно вызвать проблемы на некоторых оконечных сетевых устройствах, вынужденных обрабатывать неожиданный для них поток данных. Использование такого поведения по умолчанию злоумышленником может привести к успешной DoS-атаке на всю сеть или некоторые устройства в ней. IGMP snooping способен существенно улучшить работу сети, в которой активно используются приложения, основанные на multicast вещании.

По существу IGMP snooping есть оптимизация реалий канального уровня с учётом фактических потребностей сетевого уровня и не является функциональностью самого IGMP.

Cуществуют две реализации IGMP snooping: активный и пассивный.

* Пассивный IGMP snooping просто прослушивает IGMP трафик, никак не фильтруя его, не интерферируя с IGMP никоим образом.
* Активный IGMP snooping: Хотя snooping подразумевает пассивное прослушивание, некоторые реализации активно фильтруют IGMP-пакеты с целью уменьшить загруженность multicast маршрутизатора. Запросы на подключение и отключение, следующие к маршрутизатору, фильтруются с целью минимизации объемов пересылаемой информации. Коммутатор старается добиться того, чтобы маршрутизатор имел только одну запись подписчика на каждую multicast группу независимо от того, сколько их на самом деле. **Например:** есть два активных подписчика, и первый из них покидает группу, коммутатор определяет, что маршрутизатору эта информация не нужна, поскольку не влияет на состояние группы с точки зрения последнего. Однако, когда в следующий раз поступит обычный запрос от маршрутизатора, коммутатор пропустит ответ от оставшегося потребителя, чтобы маршрутизатор не счёл, что подписчиков больше нет. Отсюда следует, что при активном IGMP snooping маршрутизатор знает только о самом последнем участнике, присоединившемся к группе.

### MVR <a id="IGMP.IGMPSnooping.MVR-MVR"></a>

Технология Multicast VLAN Registration \(MVR\) была создана на волне развития схем построения сетей типа vlan-per-customer и vlan-per-service и должна была существенно упростить доставку multicast трафика до абонентов. Существовало два классических решения; первое – выделение мультикаста в отдельный vlan и доставка его до абонента через trunk порт. Наиболее широкое распространение получило в DSL сетях, где большинство оконечных устройств поддерживают multiPVC, а значит и поддержку нескольких vlan. Вторая – передача трафика в пользовательский vlan, а значит увеличение нагрузки на ближайший маршрутизатор.

Идея MVR заключается в предоставлении возможность пользовательскому устройству отправить JOIN и LEAVE сообщения за пределы своего VLAN. Когда на коммутатор поступает IGMP Join или Leave, то MVR процесс перехватывает их и обрабатывает вместо IGMP Snooping, разрешаю подписку не только в своем vlan. Следовательно в сети провайдера настраивается только один vlan с multicast трафиком, а клиенту нет необходимости приобретать и настраивать коммутатор с поддержкой vlan. Технология работает вместо IGMP, поэтому проблем с совместимостью нет, но присутствует ряд ограничений:

* Не работает с сообщениями формата IGMP v3
* Работает только с IGMP Leave и Join сообщениями, все остальные продолжают обрабатывать при помощи IGMP Snooping.
* Абонентский порт может быть только access 
* Количество multicast групп ограничено 512 для большинства устройств.
* Не работает на private портах.
* Не работает если включен multicast-routing

Существует два режима работы:

* Compartable Mode – multicast трафик принимается на source интерфейсе вне зависимости от того, если ли подписки в эту группу на recive портах \(по IGMP или static MVR\). Клиентам отправляется только в случае наличия join на интерфейсе.
* Dynamic Mode – multicast трафик принимается на source интерфейсе только в том случае, если есть подписка в эту группу.

Механизм управления MVR:

_Подключение \(Join\)_   
Подписчик отсылает сообщение IGMP Report на коммутатор для подключения к требуемому потоку мультикаста. Если коммутатор находит настроенный на нем MAC-адрес, соответствующий полученному запросу, процессор коммутатора меняет таблицу адресации, направляя мультикастовый VLAN \(MVLAN\) на этот порт в соответствующий VLAN.   
  
_Отключение \(Leave\)_   
Подписчик отправляет сообщение IGMP Leave на коммутатор для отключения от рассылки мультикаста. Коммутатор отсылает во VLAN этого порта групповой IGMP-запрос. Если во VLAN’е есть еще клиент, подписанный на эту рассылку, он должен ответить на запрос в течение установленного времени. В противном случае коммутатор исключает порт из списка рассылки.   
  
_Мгновенное отключение \(Immediate Leave\)_   
Подписчик отправляет сообщение IGMP Leave на коммутатор для отключения услуги, и коммутатор незамедлительно исключает соответствующий порт из списка рассылки. 

